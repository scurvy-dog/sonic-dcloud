# Lab 3 Guide: Configure BGP [40 Min]

### Description: 
In Lab 3 the student will explore the configuring the BGP routing protocol within SONiC. In this lab the FRR routing protocol stack is used to provide BGP support. 

## Contents
- [Lab 3 Guide: Configure BGP \[40 Min\]](#lab-3-guide:-configure-bgp-40-min)
    - [Description:](#description)
    - [Lab Objectives](#lab-objectives)
    - [FRR BGP Overview](#frr-bgp-overview)
    - [BGP Topology](#bgp-topology)
    - [Ansible BGP Playbook](#ansible-bgp-playbook)
    - [Configure BGP Leaf01 with FRR CLI](#configure-bgp-leaf01-with-frr-cli)
    - [Validate BGP Peering](#validate-bgp-peering)
       - [Verify BGP Peering Sessions](#verify-bgp-peering-sessions)
       - [Verify BGP Routing Table](#verify-bgp-routing-table)
    - [Validate End to End Connectivity](#Validate-end-to-end-connectivity)    
   
  - [End of Lab 3](#end-of-lab-3)
  
## Lab Objectives
The student upon completion of Lab 3 should have achieved the following objectives:

* Understand FRR configuration
* How to validate and troubleshoot BGP sesions
* Valadiate end to end topology 

## FRR BGP Overview
FRR is the routing procotol software stack in this lab. FRR supports BGP and is integrated within SONiC running it's own daemon to process the configuration work we will be doing in this lab. There are several ways to configure FRR as noted in Lab 2. 

For this lab we will be using two mechanisms to configure FRR. The first is to use ansible to update the FRR config file */etc/sonic/frr/bgpd.conf*. When we do a config reload command it will load FRR will load the BGP configurations into the running configuration which is stored in the *redis-database*. We will use this method to load FRR/BGP configuration for *spine01*, *spine02*, and *leaf02*.

For *leaf01* you will be using the FRR CLI to add the BGP configuration. There are some items of note when using the FRR CLI in SONiC.
    - For all configuration commands, the CLI request is converted to a corresponding REST client SDK request based on the Open Config data model that was generated by the Swagger generator, and is given to the REST server
    - From there on it will follow the same path as a REST config request for create, update and delete operations

## BGP Topology
In this lab we will have three separate BGP AS represented in the fabric. The spine layer will be within it's own AS 65000. Each leaf will then have it's own separate BGP AS as represented in the topology diagram below. In this BGP DC fabric the leafs should be receiving equal cost paths through each of the spine layer port-channels through AS 65000.

![BGP Topology](../topo-drawings/bgp-topology.png)

## Ansible BGP Playbook
In Lab 3 we are going to use an Ansible playbook to create the BGP configuration in the topology. That means we are going to replace the */etc/sonic/frr/bgpd.conf* file which will contain FRR BGP parameters. 

There are several relevant files for our ansible playbook

| Name                  | Location                     | Notes                         |
|:----------------------|:-----------------------------|:------------------------------|
| lab_3-playbook.yml    | /lab_3/ansible               | Ansible playbook file         |
| hosts                 | /lab_3/ansible               | Contains device list and IPs  |
| frr.conf              | /lab_3/ansible/files/{host}/ | FRR BGP file -> bgpd.conf     |

- Change to the ansible directory in Lab 3
  ```
  cd ansible
  ```
- Run Ansible playbook to copy configurations to SONiC routers. Once copied then load configurations
    ```
    ansible-playbook -i hosts lab_3-playbook.yml -e "ansible_user=cisco ansible_ssh_pass=cisco123 ansible_sudo_pass=cisco123" -vv
    ```

    You should expect a large amount of output from ansible but, at the end of logs look for the following output
    ```
    PLAY RECAP
    PLAY RECAP
    *************************************************************************************************************************
    leaf02                     : ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    spine01                    : ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    spine02                    : ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    
    ```
> [!IMPORTANT]
> Ansible playbook configured router *spine01*, *spine02*, and *leaf02*. You will manually configure BGP for router *leaf01* in this lab.

 - Check
   
## Configure BGP Leaf01 with FRR CLI
1. Enter into the FRR CLI shell
   ```
   vtysh
   ```
2. Enter into FRR configuration mode.
   ```
   config terminal
   ```
3. Start with the base BGP configuration. For *leaf01* we will be using AS65004 per the topology diagram.
   ```
   router bgp 65004
   bgp router-id 10.0.0.4
   bgp log-neighbor-changes
   no bgp ebgp-requires-policy
   no bgp default ipv4-unicast
   timers bgp 3 9
   bgp bestpath as-path multipath-relax
   neighbor 10.1.1.1 remote-as 65000
   neighbor 10.1.1.3 remote-as 65000
   neighbor fc00:0:ffff::1 remote-as 65000
   neighbor fc00:0:ffff::3 remote-as 65000
   ```
4. Next we will add the IPv4 Unicast configuration
   ```
   address-family ipv4 unicast
   network 10.0.0.4/32
   network 10.1.2.0/24
   neighbor 10.1.1.1 activate
   neighbor 10.1.1.3 activate
   exit-address-family
   ```
5. Now add the IPv6 Unicast configuration
   ```
   address-family ipv6 unicast
   network fc00:0:4::/48
   network fc00:0:::1/128
   neighbor fc00:0:ffff::1 activate
   neighbor fc00:0:ffff::3 activate
   exit-address-family
   exit
   ```
6. Verify the new running configuration in FRR
   ```
   leaf01# show running-config
   ...
   router bgp 65004
     bgp router-id 10.0.0.4
     bgp log-neighbor-changes
     no bgp ebgp-requires-policy
     no bgp default ipv4-unicast
     bgp bestpath as-path multipath-relax
     timers bgp 3 9
     neighbor 10.1.1.1 remote-as 65000        <---- Spine01 IPv4 Peer
     neighbor 10.1.1.3 remote-as 65000        <---- Spine02 IPv4 Peer
     neighbor fc00:0:ffff::1 remote-as 65000  <---- Spine01 IPv6 Peer
     neighbor fc00:0:ffff::3 remote-as 65000  <---- Spine02 IPv6 Peer
   !
   address-family ipv4 unicast
     network 10.0.0.4/32                      <---- Advertise local IPv4 network
     network 10.1.2.0/24                      <---- Advertise local IPv4 network
     neighbor 10.1.1.1 activate
     neighbor 10.1.1.3 activate
   exit-address-family
   !
   address-family ipv6 unicast
     network fc00:0:4::/48                     <---- Advertise local IPv6 network
     network fc00:0:4::1/128                   <---- Advertise local IPv6 network
     neighbor fc00:0:ffff::1 activate
     neighbor fc00:0:ffff::3 activate
   exit-address-family
   exit
   !
   ```
## Validate BGP Peering

### Verify BGP Peering Sessions
- Verify that BGP peering sessions are established with *spine01* and *spine02* from *leaf01*
  ```
  show bgp summary
  ```
  ```
  leaf01# show bgp summary
  IPv4 Unicast Summary (VRF default)
  BGP router identifier 10.0.0.4, local AS number 65004 vrf-id 0
  BGP table version 4
  RIB entries 7, using 1344 bytes of memory
  Peers 2, using 1449 KiB of memory

  Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
  10.1.1.1        4      65000        10        10        0    0    0 00:04:03            2        4 N/A
  10.1.1.3        4      65000        10        10        0    0    0 00:04:03            2        4 N/A

  Total number of neighbors 2

  IPv6 Unicast Summary (VRF default):
  BGP router identifier 10.0.0.4, local AS number 65004 vrf-id 0
  BGP table version 11
  RIB entries 8, using 1536 bytes of memory
  Peers 2, using 1449 KiB of memory

  Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
  fc00:0:ffff::1  4      65000        47        52        0    0    0 00:22:32            2        4 N/A
  fc00:0:ffff::3  4      65000        47        54        0    0    0 00:22:32            2        4 N/A

  Total number of neighbors 2
  ```
  
- Verify that BGP peering sessions are established with *spine01* and *spine02* from *leaf02*
   ```
   leaf02# show ip bgp summary
   IPv4 Unicast Summary (VRF default)
   BGP router identifier 10.0.0.4, local AS number 65004 vrf-id 0
   BGP table version 4
   RIB entries 7, using 1344 bytes of memory
   Peers 2, using 1449 KiB of memory

   Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
   10.1.1.5        4      65000       169       170        0    0    0 02:37:08            2        4 N/A
   10.1.1.7        4      65000       169       170        0    0    0 02:37:08            2        4 N/A

   Total number of neighbors 2

   IPv6 Unicast Summary (VRF default):
   BGP router identifier 10.0.0.5, local AS number 65005 vrf-id 0
   BGP table version 12
   RIB entries 8, using 1536 bytes of memory
   Peers 2, using 1449 KiB of memory

   Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
   fc00:0:ffff::5  4      65000       196       210        0    0    0 02:51:46            2        4 N/A
   fc00:0:ffff::7  4      65000       195       210        0    0    0 02:51:46            2        4 N/A

   Total number of neighbors 2
   ```
   
### Verify BGP Routing Table
- **Verify IPv4** routes *leaf01* has received the following
  ```
  show ip route bgp
  ```
  ```
  leaf01# show ip route bgp
  Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

  B>* 10.0.0.2/32 [20/0] via 10.1.1.1, PortChannel1, weight 1, 00:25:24
  B>* 10.0.0.3/32 [20/0] via 10.1.1.3, PortChannel2, weight 1, 00:25:24
  B>* 10.0.0.5/32 [20/0] via 10.1.1.1, PortChannel1, weight 1, 00:25:24
    *                    via 10.1.1.3, PortChannel2, weight 1, 00:25:24
  ```
- **Verify IPv4** routes *leaf02* has received the following
  ```
  leaf01# show ip route bgp
  Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure
  B>* 10.0.0.2/32 [20/0] via 10.1.1.7, PortChannel2, weight 1, 02:59:13
  B>* 10.0.0.3/32 [20/0] via 10.1.1.5, PortChannel1, weight 1, 02:59:13
  B>* 10.0.0.4/32 [20/0] via 10.1.1.5, PortChannel1, weight 1, 00:26:19
    *                    via 10.1.1.7, PortChannel2, weight 1, 00:26:19
  ```
  
- **Verify IPv6** routes *leaf01* has received the following
  ```
  show ipv6 route bgp
  ```
  ```
  leaf01# show ipv6 route bgp
  Codes: K - kernel route, C - connected, S - static, R - RIPng,
       O - OSPFv3, I - IS-IS, B - BGP, N - NHRP, T - Table,
       v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

  B>* fc00:0:2::1/128 [20/0] via fe80::5054:ff:fe74:c103, PortChannel1, weight 1, 00:06:02
  B>* fc00:0:3::1/128 [20/0] via fe80::5054:ff:fe74:c104, PortChannel2, weight 1, 00:06:02
  B>* fc00:0:5::1/128 [20/0] via fe80::5054:ff:fe74:c103, PortChannel1, weight 1, 00:06:02
    *                        via fe80::5054:ff:fe74:c104, PortChannel2, weight 1, 00:06:02
  ```
- **Verify IPv6** routes *leaf02* has received the following
  ```
  leaf02# show ipv6 route bgp
  Codes: K - kernel route, C - connected, S - static, R - RIPng,
       O - OSPFv3, I - IS-IS, B - BGP, N - NHRP, T - Table,
       v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure
  B>* fc00:0:2::1/128 [20/0] via fc00:0:ffff::7, PortChannel2, weight 1, 00:09:31
  B>* fc00:0:3::1/128 [20/0] via fc00:0:ffff::5, PortChannel1, weight 1, 00:09:32
  B>* fc00:0:4::1/128 [20/0] via fc00:0:ffff::5, PortChannel1, weight 1, 00:05:50
    *                        via fc00:0:ffff::7, PortChannel2, weight 1, 00:05:50
  ```
- Examine IPv4 BGP AS Path information in the route table. This shows us what routes are installed in the BGP table vs which routes are installed into the routing table.
  ```
  show bgp ipv4 unicast
  ```
  ```
  leaf01# show bgp ipv4 uni
  BGP table version is 10, local router ID is 10.0.0.4, vrf id 0
  Default local pref 100, local AS 65004
  Status codes:  s suppressed, d damped, h history, * valid, > best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
  Nexthop codes: @NNN nexthop's vrf id, < announce-nh-self
  Origin codes:  i - IGP, e - EGP, ? - incomplete
  RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
  *> 10.0.0.2/32      10.1.1.1                 0             0 65000 i
  *> 10.0.0.3/32      10.1.1.3                 0             0 65000 i
  *> 10.0.0.4/32      0.0.0.0                  0         32768 i
  *> 10.0.0.5/32      10.1.1.1                               0 65000 65005 i
  *=                  10.1.1.3                               0 65000 65005 i

  Displayed  4 routes and 5 total paths
  ```
- Examine IPv6 BGP AS Path information in the route table
  ```
  leaf01# show bgp ipv6 uni
  BGP table version is 11, local router ID is 10.0.0.4, vrf id 0
  Default local pref 100, local AS 65004
  Status codes:  s suppressed, d damped, h history, * valid, > best, = multipath,
               i internal, r RIB-failure, S Stale, R Removed
  Nexthop codes: @NNN nexthop's vrf id, < announce-nh-self
  Origin codes:  i - IGP, e - EGP, ? - incomplete
  RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop                 Metric LocPrf Weight Path
  *> fc00:0:2::1/128  fe80::5054:ff:fe74:c103       0             0 65000 i
  *> fc00:0:3::1/128  fe80::5054:ff:fe74:c104
                                                    0             0 65000 i
     fc00:0:4::/48    ::                            0         32768       i
  *> fc00:0:4::1/128  ::                            0         32768       i
  *> fc00:0:5::1/128  fe80::5054:ff:fe74:c103       0               65000 65005
  *=                  fe80::5054:ff:fe74:c104       0               65000 65005 i

## Validate End to End Connectivity

- From *leaf01* we will ping the *loopback0* interface on *leaf02*
  ```
  ping 10.0.0.5
  ```
  ```
  leaf01# ping 10.0.0.5
  PING 10.0.0.5 (10.0.0.5) 56(84) bytes of data.
  64 bytes from 10.0.0.5: icmp_seq=1 ttl=63 time=2.10 ms
  64 bytes from 10.0.0.5: icmp_seq=2 ttl=63 time=1.75 ms
  ```

## End of Lab 3
Please proceed to [Lab 4](https://github.com/scurvy-dog/sonic-dcloud/blob/main/1-Intro_to_SONiC_Lab/lab_4/lab_4-guide.md)
